<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>True Love - Telegram Mini App</title>
    
    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js?58"></script>
    
    <!-- React и ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel для транспиляции JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #root {
            height: 100vh;
            width: 100vw;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Загружаем Telegram WebApp скрипт если он еще не загружен
        if (!window.Telegram) {
          const script = document.createElement('script');
          script.src = 'https://telegram.org/js/telegram-web-app.js?58';
          script.async = true;
          document.head.appendChild(script);
        }

        // Telegram WebApp API integration
        const getTelegramWebApp = () => {
          return window.Telegram?.WebApp;
        };

        // Вынесем ChatInput полностью за пределы основного компонента
        const ChatInput = React.memo(({ matchId, onSendMessage }) => {
          const [message, setMessage] = useState('');
          
          const handleSend = useCallback(() => {
            const messageText = message.trim();
            console.log('🔄 ChatInput handleSend:', { matchId, message: messageText });
            
            if (messageText) {
              console.log('✅ Отправляем сообщение:', messageText);
              onSendMessage(matchId, messageText);
              setMessage('');
              console.log('🧹 Очищен input');
            } else {
              console.log('❌ Пустое сообщение, не отправляем');
            }
          }, [matchId, message, onSendMessage]);

          const handleKeyPress = useCallback((e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              handleSend();
            }
          }, [handleSend]);

          const handleChange = useCallback((e) => {
            setMessage(e.target.value);
          }, []);

          return (
            <div className="bg-white p-4 border-t border-gray-100">
              <div className="flex items-center space-x-2">
                <input
                  type="text"
                  value={message}
                  onChange={handleChange}
                  onKeyPress={handleKeyPress}
                  placeholder="Напишите сообщение..."
                  className="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:border-pink-500"
                  autoComplete="off"
                />
                <button
                  onClick={handleSend}
                  className="p-2 bg-pink-500 text-white rounded-full hover:bg-pink-600 transition-colors"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                  </svg>
                </button>
              </div>
            </div>
          );
        });

        // Основной компонент
        const DatingApp = () => {
          const [currentView, setCurrentView] = useState('discover');
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [userProfile, setUserProfile] = useState(null);
          const [authError, setAuthError] = useState(null);

          // Инициализация и авторизация
          useEffect(() => {
            const initializeApp = async () => {
              console.log('🚀 Инициализация приложения...');
              
              // Простая имитация авторизации
              setTimeout(() => {
                const testUser = {
                  id: Date.now(),
                  first_name: 'Кирилл',
                  last_name: 'Лукичев',
                  username: 'kirill_test',
                  language_code: 'ru',
                  is_premium: false
                };
                
                setUserProfile(testUser);
                setIsAuthenticated(true);
                setAuthError('Тестовый режим (готово к интеграции с Telegram)');
              }, 1000);
            };

            initializeApp();
          }, []);

          // Пользователь из авторизованных данных
          const currentUser = userProfile ? {
            name: userProfile.first_name || "Пользователь",
            telegramId: userProfile.id,
            username: userProfile.username,
            firstName: userProfile.first_name,
            lastName: userProfile.last_name,
            languageCode: userProfile.language_code,
            isPremium: userProfile.is_premium || false,
            age: 28,
            bio: "Frontend разработчик, путешественник, любитель кофе и хорошей музыки",
            interests: ["Программирование", "Путешествия", "Кофе", "Музыка", "Спорт"],
            photos: [
              "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=400&fit=crop&crop=face",
              "https://images.unsplash.com/photo-1522075469751-3a6694fb2f61?w=400&h=400&fit=crop&crop=face",
              "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=400&fit=crop&crop=face"
            ]
          } : null;

          // Демо-профили
          const profiles = [
            {
              id: 1,
              name: "Екатерина",
              age: 23,
              city: "Москва",
              distance: 2,
              bio: "Ищу родственную душу 💫",
              interests: ["Православие", "Книги", "Рукоделие", "Природа", "Кулинария"],
              photos: [
                "https://images.unsplash.com/photo-1494790108755-2616c5e2d06d?w=400&h=600&fit=crop&crop=face",
                "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=400&h=600&fit=crop&crop=face"
              ],
              job: "Дизайнер",
              education: "МГУ",
              height: "162 см"
            },
            {
              id: 2,
              name: "Анна",
              age: 25,
              city: "Москва", 
              distance: 5,
              bio: "Люблю жизнь во всех её проявлениях ✨",
              interests: ["Фотография", "Йога", "Путешествия", "Мода", "Искусство"],
              photos: [
                "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400&h=600&fit=crop&crop=face",
                "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=400&h=600&fit=crop&crop=face"
              ],
              job: "Фотограф",
              education: "Школа фотографии",
              height: "165 см"
            }
          ];

          // Простые состояния
          const [currentProfile, setCurrentProfile] = useState(0);
          const [matches, setMatches] = useState([]);
          const [selectedMatch, setSelectedMatch] = useState(null);
          const [chatMessages, setChatMessages] = useState({});

          const nextProfile = () => {
            setCurrentProfile((prev) => (prev + 1) % profiles.length);
          };

          const handleLike = () => {
            const profile = profiles[currentProfile];
            
            // Создаем совпадение
            if (Math.random() > 0.3) {
              const existingMatch = matches.find(m => m.id === profile.id);
              if (!existingMatch) {
                setMatches([...matches, profile]);
                alert(`💕 Совпадение с ${profile.name}!`);
              }
            }
            nextProfile();
          };

          const handleDislike = () => {
            nextProfile();
          };

          const sendMessage = useCallback((matchId, message) => {
            const newMsg = {
              id: Date.now(),
              text: message.trim(),
              sender: 'user',
              timestamp: new Date().toISOString()
            };
            
            setChatMessages(prev => ({
              ...prev,
              [matchId]: [...(prev[matchId] || []), newMsg]
            }));

            // Автоответ через 2 секунды
            setTimeout(() => {
              const autoReply = {
                id: Date.now() + 1,
                text: "Привет! Рада нашему знакомству! 😊",
                sender: 'match',
                timestamp: new Date().toISOString()
              };
              
              setChatMessages(prev => ({
                ...prev,
                [matchId]: [...(prev[matchId] || []), autoReply]
              }));
            }, 2000);
          }, []);

          // Компонент загрузки
          if (!isAuthenticated || !currentUser) {
            return (
              <div className="flex flex-col items-center justify-center h-full bg-gradient-to-br from-pink-500 to-purple-600">
                <div className="text-white text-center">
                  <div className="text-6xl mb-6">💕</div>
                  <h1 className="text-3xl font-bold mb-4">True Love</h1>
                  <div className="animate-spin w-8 h-8 border-4 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
                  <p className="text-white/80">Загрузка приложения...</p>
                  {authError && (
                    <div className="mt-4 p-3 bg-green-500/20 rounded-lg">
                      <p className="text-sm text-green-100">✅ {authError}</p>
                    </div>
                  )}
                </div>
              </div>
            );
          }

          // Основной интерфейс
          return (
            <div className="w-full h-full max-w-md mx-auto flex flex-col relative bg-white">
              {/* Главный контент */}
              <div className="flex-1 overflow-hidden">
                {currentView === 'discover' && (
                  <div className="flex flex-col h-full bg-white">
                    {/* Карточка профиля */}
                    <div 
                      className="flex-1 relative bg-cover bg-center"
                      style={{ 
                        backgroundImage: `linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.7) 100%), url('${profiles[currentProfile].photos[0]}')`
                      }}
                    >
                      {/* Информация */}
                      <div className="absolute bottom-0 left-0 right-0 p-6 text-white">
                        <h2 className="text-3xl font-bold mb-2">
                          {profiles[currentProfile].name}, {profiles[currentProfile].age}
                        </h2>
                        <p className="text-white/90 text-sm mb-4">{profiles[currentProfile].bio}</p>
                        <div className="flex items-center text-white/70 text-sm">
                          <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                          </svg>
                          <span>{profiles[currentProfile].distance} км</span>
                        </div>
                      </div>
                    </div>

                    {/* Кнопки управления */}
                    <div className="bg-white p-4">
                      <div className="flex justify-center items-center space-x-4">
                        <button
                          onClick={handleDislike}
                          className="w-14 h-14 bg-white rounded-full shadow-lg border border-gray-200 flex items-center justify-center hover:scale-105 transition-transform"
                        >
                          <svg className="w-7 h-7 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>

                        <button
                          onClick={handleLike}
                          className="w-14 h-14 bg-white rounded-full shadow-lg border border-gray-200 flex items-center justify-center hover:scale-105 transition-transform"
                        >
                          <svg className="w-7 h-7 text-pink-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 4.318c-1.754-1.753-4.596-1.753-6.35 0-1.753 1.754-1.753 4.596 0 6.35L12 17.018l6.35-6.35c1.753-1.754 1.753-4.596 0-6.35-1.754-1.753-4.596-1.753-6.35 0z" />
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {currentView === 'chats' && (
                  <div className="flex flex-col h-full bg-white">
                    {selectedMatch ? (
                      <div className="flex flex-col h-full">
                        {/* Хедер чата */}
                        <div className="bg-white p-4 shadow-sm border-b border-gray-100 flex items-center">
                          <button
                            onClick={() => setSelectedMatch(null)}
                            className="mr-3 p-2 hover:bg-gray-100 rounded-full transition-colors"
                          >
                            <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                            </svg>
                          </button>
                          <img 
                            src={selectedMatch.photos[0]}
                            alt={selectedMatch.name}
                            className="w-10 h-10 rounded-full object-cover border-2 border-pink-200 mr-3"
                          />
                          <div>
                            <h3 className="font-semibold text-gray-800">{selectedMatch.name}</h3>
                            <p className="text-sm text-gray-500">Онлайн</p>
                          </div>
                        </div>

                        {/* Сообщения */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                          {(chatMessages[selectedMatch.id] || []).length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-full">
                              <div className="text-4xl mb-4">💝</div>
                              <h4 className="text-lg font-semibold text-gray-800 mb-2">Совпадение!</h4>
                              <p className="text-gray-500 text-center">Вы понравились друг другу! Начните разговор</p>
                            </div>
                          ) : (
                            (chatMessages[selectedMatch.id] || []).map((msg, index) => (
                              <div
                                key={index}
                                className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}
                              >
                                <div
                                  className={`max-w-xs px-4 py-2 rounded-2xl ${
                                    msg.sender === 'user'
                                      ? 'bg-pink-500 text-white ml-12'
                                      : 'bg-gray-100 text-gray-800 mr-12'
                                  }`}
                                >
                                  <p className="text-sm">{msg.text}</p>
                                </div>
                              </div>
                            ))
                          )}
                        </div>

                        {/* Поле ввода */}
                        <ChatInput 
                          matchId={selectedMatch.id} 
                          onSendMessage={sendMessage} 
                        />
                      </div>
                    ) : (
                      <div className="flex flex-col h-full">
                        <div className="bg-white p-4 shadow-sm border-b border-gray-100">
                          <h2 className="text-xl font-bold text-gray-800">Чаты</h2>
                          <p className="text-gray-500 text-sm">{matches.length} совпадений</p>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto">
                          {matches.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-full p-8">
                              <div className="text-6xl mb-4">💬</div>
                              <h3 className="text-lg font-semibold text-gray-800 mb-2">Пока нет совпадений</h3>
                              <p className="text-gray-500 text-center">Когда вы понравитесь друг другу, здесь появятся ваши совпадения</p>
                            </div>
                          ) : (
                            <div className="p-4 space-y-3">
                              {matches.map((match) => (
                                <div 
                                  key={match.id}
                                  onClick={() => setSelectedMatch(match)}
                                  className="flex items-center p-3 bg-white rounded-lg border border-gray-100 hover:bg-gray-50 cursor-pointer"
                                >
                                  <img 
                                    src={match.photos[0]}
                                    alt={match.name}
                                    className="w-14 h-14 rounded-full object-cover border-2 border-pink-200"
                                  />
                                  <div className="ml-3 flex-1">
                                    <h4 className="font-semibold text-gray-800">{match.name}</h4>
                                    <p className="text-sm text-gray-500">Вы понравились друг другу!</p>
                                  </div>
                                  <div className="w-3 h-3 bg-pink-500 rounded-full"></div>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {currentView === 'profile' && (
                  <div className="flex flex-col h-full bg-white">
                    <div className="bg-white p-4 shadow-sm border-b border-gray-100">
                      <h2 className="text-xl font-bold text-gray-800">Мой профиль</h2>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-6">
                      <div className="text-center mb-6">
                        <img 
                          src={currentUser.photos[0]}
                          alt={currentUser.name}
                          className="w-32 h-32 rounded-full mx-auto object-cover border-4 border-pink-200 mb-4"
                        />
                        <h3 className="text-2xl font-bold text-gray-800">{currentUser.name}, {currentUser.age}</h3>
                        <p className="text-gray-600 mt-2">{currentUser.bio}</p>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* Tab bar */}
              <div className="bg-white border-t border-gray-200 flex shrink-0">
                <button
                  onClick={() => setCurrentView('chats')}
                  className={`flex-1 py-3 px-4 text-center transition-colors ${
                    currentView === 'chats' ? 'text-pink-500' : 'text-gray-400'
                  }`}
                >
                  <div className="w-6 h-6 mx-auto mb-1">
                    <svg fill="currentColor" viewBox="0 0 24 24">
                      <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                    </svg>
                  </div>
                </button>
                
                <button
                  onClick={() => setCurrentView('discover')}
                  className={`flex-1 py-3 px-4 text-center transition-colors ${
                    currentView === 'discover' ? 'text-pink-500' : 'text-gray-400'
                  }`}
                >
                  <div className="w-6 h-6 mx-auto mb-1">
                    <svg fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                  </div>
                </button>
                
                <button
                  onClick={() => setCurrentView('profile')}
                  className={`flex-1 py-3 px-4 text-center transition-colors ${
                    currentView === 'profile' ? 'text-pink-500' : 'text-gray-400'
                  }`}
                >
                  <div className="w-6 h-6 mx-auto mb-1">
                    <svg fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                  </div>
                </button>
              </div>
            </div>
          );
        };

        // Рендерим приложение
        ReactDOM.render(<DatingApp />, document.getElementById('root'));
    </script>
</body>
</html>
